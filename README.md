# Rust-IME (Blind IME) 使用手册

这是一个专为 Linux 设计的高性能、现代化中文输入法引擎。采用 Rust 编写，深度适配 Wayland/COSMIC 桌面环境，提供极致的丝滑盲打体验。

---

## 🚀 今日更新：高性能二进制架构 (Binary Engine)

程序已完成底层重构，采用了类 **Rime (小狼毫)** 的高性能架构：

### 1. 0 秒启动与内存映射 (Mmap)
- **原理**：不再在启动时解析沉重的 JSON 词库。通过 `memmap2`，程序启动时仅建立文件映射映射关系。
- **优势**：启动时间从秒级缩短至 **微秒级**；只有真正输入的拼音对应的词条会被按需加载进物理内存，极大地降低了常驻内存占用。

### 2. FST 高效索引
- **原理**：使用 **Finite State Transducer (确定性有限状态转录机)** 算法。
- **优势**：实现了 O(1) 复杂度的拼音前缀查找，即便加载百万级的词库，打字也绝无卡顿。

### 3. 两层 N-gram 评分系统
- **静态层 (Mmap)**：预训练的大规模语料库（数百万跳转）以二进制形式存储，查询极快。
- **动态层 (Memory)**：实时学习用户的打字习惯，并自动保存为 `user_adapter.json`，确保输入法越用越懂你。

---

## 🛠 核心功能与特色

### 1. 英文辅码 (English Auxiliary Coding)
使用英文单词的首字母作为汉字的辅码，实现零重码盲打。
- **示例**：输入 `ni` (你/泥/尼...) -> 输入 `niM` (Mud 的首字母 M) -> 直接锁定“泥”。

### 2. COSMIC / Wayland 深度稳定性优化
针对 COSMIC 等新兴合成器进行了专项适配：
- **始终映射策略**：通过控制窗口透明度而非频繁销毁/创建 Surface，彻底解决了 COSMIC 下常见的 `Broken pipe` 崩溃问题。
- **架构解耦**：IME 核心逻辑运行在主线程，GUI 运行在独立插件线程。即使 GUI 因 Wayland 协议异常崩溃，主线程依然能保持稳定输入。

### 3. 按键回显功能 (Keystroke Cast)
支持在屏幕右下角实时显示按键组合，适合演示或录屏。
- **默认关闭**：可通过托盘菜单手动开启。
- **智能清理**：按键会在显示 1 秒后自动消失。

### 4. 智能滑动窗口选词 (Sliding Window)
- **`Tab` / `Shift + Tab`**: 顺滑滚动选中词条。
- **`1-5`**: 直接选中当前视野内的词。

---

## 💻 快速开始 (Quick Start)

### 1. 编译二进制词库
在首次运行或更新 `dicts/*.json` 后，必须先编译索引：
```bash
cargo run --bin compile_dict
```

### 2. 运行输入法
```bash
cargo build
./target/debug/rust-ime --foreground  # 前台运行（调试推荐）
# 或直接运行后台模式
./target/debug/rust-ime
```

---

## ⚙️ 默认设置与开关

- **桌面通知**：**默认开启**。切换模式或输入时会有实时提醒。
- **候选框**：**默认关闭**。盲打推荐模式，如需开启请使用托盘菜单。
- **按键回显**：**默认关闭**。
- **快捷键重置**：按下 `Ctrl / Alt / Meta` 组合键时，程序会自动清空当前的拼音缓存并重置状态，防止误触。

---

## 🛡 运行权限与安全

1. **uinput 权限**：用户必须在 `input` 组：
   ```bash
   sudo usermod -aG input,uinput $USER
   ```
2. **信号隔离**：主线程已忽略 `SIGPIPE` 信号，极大增强了在不稳定 Wayland 环境下的抗崩溃能力。

---

## 📊 架构设计 (Internal Architecture)
- **主线程**：核心循环、`evdev` 键盘抓取、字典查询、`uinput` 虚拟键盘发射。
- **UI 线程**：GTK4 渲染、`layer-shell` 协议处理。
- **Web 线程**：基于 `axum` 的配置中心（端口 8765）。
- **通知线程**：异步处理系统级 D-Bus 通知。