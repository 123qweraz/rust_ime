# rust-IME 使用手册

这是一个专为 Linux 设计的高性能、现代化中文输入法引擎。采用 Rust 编写，深度适配 Wayland/COSMIC 桌面环境，提供极致的丝滑盲打体验。

---

## 💡 设计哲学与初衷 (Philosophy)

### 1. 为什么要做这个输入法？
拼音输入法最大的痛点在于 **“重码选择”**。即便全拼输入非常自然，但面对“里、力、理、利”等大量同音字时，选词过程极大地打断了思维流。

**rust-IME 的降维打击：**
- **英文辅码 (English Auxiliary)**：我们认为，现代开发者和重度电脑用户大脑中已经储备了大量的英文词汇。通过调用你本能的英文知识来实现**零重码盲打**。
- **示例**：你想打“泥”，只需输入 `niM`（M 代表英文单词 Mud 的首字母）。

### 2. 行业锐评 (Hot Takes)
- **对比五笔**：学习曲线极其陡峭，且容易忘记拆解规则。
- **对比双拼**：只解决了“输入快”，没解决“选词慢”。
- **结论**：**全拼 + 英文辅码 + 简拼** 才是速度与直觉的完美平衡。

---

## 🛠 核心功能特性

### 1. 四声调过滤与智能纠错 (Tones)
利用数字键快速锁定声调，消除 80% 的重码：
- `7`: 一声 (ā) | `8`: 二声 (á) | `9`: 三声 (ǎ) | `0`: 四声 (à)
- **用法**：输入 `ni9` -> 直接过滤出“你”、“拟”等三声字。
- **智能纠错**：如果你输入的拼音拼写有误，程序会优先匹配符合声调的候选词。

### 2. 汉字学习模式 (Learning Mode)
- **原理**：在输入法闲置时，在按键回显位置（通常是角落）自动轮播展示汉字及其对应的英文释义。
- **扩展性**：支持加载**日语词库**（如 N1-N5 JSON），在打字之余利用碎片时间记忆假名或单词。

### 3. 高性能二进制架构
- **0 秒启动**：基于 `memmap2` 内存映射，无论词库多大，加载均为微秒级。
- **FST 索引**：O(1) 复杂度的前缀查找，绝无卡顿。

---

## ⌨️ 默认快捷键 (Default Hotkeys)

| 快捷键 | 功能描述 |
| :--- | :--- |
| **`Caps Lock`** | 切换中 / 英文输入模式 |
| **`Ctrl + Space`** | 切换中 / 英文输入模式 (备选) |
| **`Tab`** | 候选词向下滚动 (Sliding Down) |
| **`Shift + Tab`** | 候选词向上滚动 (Sliding Up) |
| **`- / =`** | 候选词快速向上 / 向下翻页 |
| **`1 - 5`** | 直接选择当前视野内的候选词 |
| **`Ctrl + Alt + P`** | 循环切换输入预览模式 (无/拼音/汉字) |
| **`Ctrl + Alt + N`** | 开启 / 关闭桌面候选词通知 |
| **`Ctrl + Alt + S`** | 快速切换输入方案 (如 中文 <-> 日语) |
| **`Ctrl + Alt + V`** | 切换自动粘贴模式 (Ctrl+V / Shift+Ins) |
| **`Ctrl + Alt + B`** | 切换退格键编码 (Delete / Backspace) |
| **`Caps Lock + Tab`** | 发送真实的 CapsLock 信号 (大写锁定) |

---

## 💻 命令行用法 (CLI Usage)

- `rust-ime`: 默认进入后台守护模式。
- `rust-ime --stop`: 安全停止进程并清理 PID。
- `rust-ime --restart`: 快速重载配置与词库。
- `rust-ime --install`: 一键安装桌面自启动。
- `rust-ime --train <dir>`: 递归扫描目录进行 N-gram 增量学习。
- `rust-ime nihao`: 命令行即时转换拼音。

---

## 🎨 视觉与外观 (Web Dashboard)

访问 `http://localhost:8765` 享受 Apple 风格的配置体验：
- **外观调整**: 在线自定义候选窗位置、RGBA 颜色、字体大小、阴影。
- **学习设置**: 指定学习模式使用的特定字典文件（如 `kana.json`）。
- **一键编译**: 修改 JSON 词库后，点击网页按钮即可一键更新二进制索引。

---

## 📚 词库管理与扩展 (Dictionary Management)

### 1. 添加新词库
本系统支持 **JSON** (标准格式) 和 **YAML** (Rime 格式) 两种字典：
- 在 `dicts/` 目录下创建新文件夹（如 `dicts/my_dict/`）。
- 将你的 `.json` 或 `.dict.yaml` 文件放入该文件夹。

### 2. 编译词库 (Binary Compilation)
为了实现微秒级的搜索速度，新增或修改词库后需要编译为二进制索引：
```bash
cargo run --bin compile_dict
```
**特性**：
- **增量编译**：自动检测源文件变动，仅编译有修改的方案，极速跳过未变动词库（如大型 Rime 词库）。
- **结构化存储**：各方案数据独立存储在 `data/<方案名>/` 下，支持私有 N-gram 模型。

### 3. 动态切换
- **自动加载**: 程序启动时会自动加载 `data/` 目录下的所有可用词库。
- **实时切换**: 使用快捷键 **`Ctrl + Alt + S`** 在已加载的词库方案之间循环切换。

---

## 🛡 运行权限与安全
1. **系统权限**：需加入 `input` 和 `uinput` 用户组。
2. **Wayland 防护**：自动屏蔽 `SIGPIPE` 信号，在不稳定合成器下依然稳健。

---

## 🚀 性能与稳定性优化 (Stability & Performance)

### 1. 零 Panic 保证
- **安全解析**: 全面重构了 Trie 树与 N-gram 模型的二进制解析逻辑，引入边界检查，彻底消除因词库损坏导致的程序崩溃。
- **错误处理**: 移除了代码中所有的 `unwrap()` 调用，采用 Rust 惯用的 `Result` 和 `Option` 模式，确保在极端环境下（如端口占用、锁竞争）依然能优雅处理错误。

### 2. 极致响应
- **预加载机制**: 将拼音分词音节表等静态资源移至启动阶段加载，消除首次输入的“冷启动”卡顿感。
- **Wayland 优化**: 在窗口隐藏时自动禁用 `can_target` 属性，解决了不可见窗口遮挡底层点击的 Click-through 问题。
- **智能窗口感知**: 自动检测当前活动窗口。当切换到终端（Terminal）时，上屏模式会自动切换为 `Ctrl+Shift+V`，离开终端后自动恢复为标准 `Ctrl+V`。

### 3. 后台稳定性
- **异步解耦**: Web 配置服务器与 IME 核心逻辑深度解耦，确保配置界面的网络波动不会影响打字体验。
- **健壮的并发**: 优化了 `RwLock` 的使用策略，防止锁中毒导致的级联失效。