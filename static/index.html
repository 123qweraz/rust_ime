<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rust-IME 控制中心</title>
    <style>
        :root {
            --apple-bg: #f5f5f7;
            --apple-card: rgba(255, 255, 255, 0.8);
            --apple-accent: #0071e3;
            --apple-text: #1d1d1f;
            --apple-secondary: #86868b;
            --apple-border: rgba(0, 0, 0, 0.1);
            --apple-glass: blur(20px) saturate(180%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Myriad Set Pro", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: var(--apple-bg);
            color: var(--apple-text);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        aside {
            width: 260px;
            background: rgba(245, 245, 247, 0.6);
            backdrop-filter: var(--apple-glass);
            border-right: 1px solid var(--apple-border);
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .logo {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 30px;
            padding-left: 15px;
            letter-spacing: -0.5px;
        }

        nav button {
            width: 100%;
            text-align: left;
            padding: 12px 15px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            color: var(--apple-text);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        nav button:hover { background: rgba(0, 0, 0, 0.05); }
        nav button.active {
            background: var(--apple-accent);
            color: white;
        }

        /* Main Content */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 60px 80px;
            scroll-behavior: smooth;
        }

        .tab-content { display: none; max-width: 800px; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 { font-size: 40px; font-weight: 700; margin-bottom: 40px; letter-spacing: -1px; }
        h2 { font-size: 24px; font-weight: 600; margin: 40px 0 20px; }

        .card {
            background: var(--apple-card);
            backdrop-filter: var(--apple-glass);
            border-radius: 18px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--apple-border);
            box-shadow: 0 4px 24px rgba(0,0,0,0.04);
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--apple-border);
        }
        .setting-item:last-child { border-bottom: none; }

        .info { flex: 1; }
        .info .title { font-weight: 600; font-size: 16px; }
        .info .desc { font-size: 13px; color: var(--apple-secondary); margin-top: 2px; }

        /* Inputs */
        input[type="text"], input[type="number"], select {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            width: 180px;
            outline: none;
            transition: all 0.2s;
        }
        input:focus { border-color: var(--apple-accent); background: white; }

        input[type="color"] {
            width: 40px; height: 40px; border: none; border-radius: 50%; overflow: hidden; cursor: pointer;
        }

        /* Switch */
        .switch {
            position: relative; display: inline-block; width: 50px; height: 28px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: #34c759; }
        input:checked + .slider:before { transform: translateX(22px); }

        .btn {
            background: var(--apple-accent);
            color: white; border: none; border-radius: 12px;
            padding: 12px 24px; font-weight: 600; font-size: 16px;
            cursor: pointer; transition: all 0.2s;
        }
        .btn:hover { transform: scale(1.02); filter: brightness(1.1); }
        .btn:active { transform: scale(0.98); }

        /* Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* Table Style */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; color: var(--apple-secondary); font-size: 12px; text-transform: uppercase; }
        td { padding: 12px; border-top: 1px solid var(--apple-border); }

        .status-toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 30px;
            border-radius: 20px; font-weight: 500; display: none; z-index: 1000;
        }
    </style>
</head>
<body>
    <aside>
        <div class="logo">rust-IME</div>
        <nav>
            <button id="nav-general" class="active" onclick="showTab('general')">系统总览</button>
            <button id="nav-appearance" onclick="showTab('appearance')">视觉与样式</button>
            <button id="nav-hotkeys" onclick="showTab('hotkeys')">快捷键</button>
            <button id="nav-dicts" onclick="showTab('dicts')">词库管理</button>
        </nav>
        <div style="margin-top: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px;">
            <button class="btn" style="width: 100%;" onclick="saveAll()">保存更改</button>
            <button class="btn" style="width: 100%; background: #5856d6;" onclick="compileDicts()">编译词库</button>
            <button class="btn" style="width: 100%; background: #ff3b30;" onclick="resetAll()">重置默认值</button>
        </div>
    </aside>

    <main>
        <!-- General -->
        <div id="tab-general" class="tab-content active">
            <h1>系统总览</h1>
            <div class="card">
                <div class="setting-item">
                    <div class="info">
                        <div class="title">默认输入方案</div>
                        <div class="desc">程序启动时加载的首选词库</div>
                    </div>
                    <select id="default_profile"></select>
                </div>
                <div class="setting-item">
                    <div class="info">
                        <div class="title">粘贴注入方式</div>
                        <div class="desc">针对不同终端或应用的兼容性模式</div>
                    </div>
                    <select id="paste_method">
                        <option value="ctrl_v">标准 (Ctrl+V)</option>
                        <option value="ctrl_shift_v">终端 (Ctrl+Shift+V)</option>
                        <option value="shift_insert">X11 (Shift+Insert)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <div class="info">
                        <div class="title">开机自启动</div>
                        <div class="desc">登录后自动在后台运行输入法引擎</div>
                    </div>
                    <label class="switch"><input type="checkbox" id="autostart"><span class="slider"></span></label>
                </div>
                <div class="setting-item">
                    <div class="info">
                        <div class="title">模糊拼音</div>
                        <div class="desc">开启 z/zh, c/ch, s/sh 等模糊匹配</div>
                    </div>
                    <label class="switch"><input type="checkbox" id="enable_fuzzy_pinyin"><span class="slider"></span></label>
                </div>
            </div>
        </div>

        <!-- Appearance -->
        <div id="tab-appearance" class="tab-content">
            <h1>视觉与样式</h1>
            
            <h2>功能开关</h2>
            <div class="card">
                <div class="setting-item">
                    <div class="info"><div class="title">显示候选窗</div><div class="desc">在屏幕指定位置显示选词列表</div></div>
                    <label class="switch"><input type="checkbox" id="show_candidates"><span class="slider"></span></label>
                </div>
                <div class="setting-item">
                    <div class="info"><div class="title">显示按键回显</div><div class="desc">在角落实时显示物理按键输入</div></div>
                    <label class="switch"><input type="checkbox" id="show_keystrokes"><span class="slider"></span></label>
                </div>
                <div class="setting-item">
                    <div class="info"><div class="title">显示系统通知</div><div class="desc">使用 D-Bus 发送状态切换提醒</div></div>
                    <label class="switch"><input type="checkbox" id="show_notifications"><span class="slider"></span></label>
                </div>
                <div class="setting-item">
                    <div class="info"><div class="title">汉字学习模式</div><div class="desc">在闲置时轮播汉字及其英文释义</div></div>
                    <label class="switch"><input type="checkbox" id="learning_mode"><span class="slider"></span></label>
                </div>
                <div class="setting-item">
                    <div class="info"><div class="title">学习模式词库</div><div class="desc">指定学习模式使用的特定字典文件</div></div>
                    <select id="learning_dict_path"></select>
                </div>
                <div class="setting-item">
                    <div class="info"><div class="title">学习轮播间隔 (秒)</div></div>
                    <input type="number" id="learning_interval_sec" min="1">
                </div>
            </div>

            <h2>候选词窗口 (OSD)</h2>
            <div class="card">
                <div class="grid-2">
                    <div class="setting-item">
                        <div class="info"><div class="title">垂直位置</div></div>
                        <select id="candidate_anchor"><option value="bottom">底部</option><option value="top">顶部</option></select>
                    </div>
                    <div class="setting-item">
                        <div class="info"><div class="title">字体大小</div></div>
                        <input type="number" id="candidate_font_size">
                    </div>
                </div>
                <div class="grid-2">
                    <div class="setting-item">
                        <div class="info"><div class="title">水平偏移 (X)</div></div>
                        <input type="number" id="candidate_margin_x">
                    </div>
                    <div class="setting-item">
                        <div class="info"><div class="title">垂直边距 (Y)</div></div>
                        <input type="number" id="candidate_margin_y">
                    </div>
                </div>
                <div class="setting-item">
                    <div class="info"><div class="title">背景颜色</div><div class="desc">支持半透明 (RGBA)</div></div>
                    <input type="text" id="candidate_bg_color" placeholder="rgba(20,20,20,0.85)">
                </div>
            </div>

            <h2>按键回显窗口</h2>
            <div class="card">
                <div class="grid-2">
                    <div class="setting-item">
                        <div class="info"><div class="title">显示位置</div></div>
                        <select id="keystroke_anchor">
                            <option value="bottom_right">右下角</option>
                            <option value="bottom_left">左下角</option>
                            <option value="top_right">右上角</option>
                            <option value="top_left">左上角</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <div class="info"><div class="title">消失延迟 (ms)</div></div>
                        <input type="number" id="keystroke_timeout_ms">
                    </div>
                </div>
                <div class="grid-2">
                    <div class="setting-item">
                        <div class="info"><div class="title">字体大小</div></div>
                        <input type="number" id="keystroke_font_size">
                    </div>
                    <div class="setting-item">
                        <div class="info"><div class="title">背景颜色</div></div>
                        <input type="text" id="keystroke_bg_color">
                    </div>
                </div>
            </div>
        </div>

        <!-- Hotkeys -->
        <div id="tab-hotkeys" class="tab-content">
            <h1>快捷键</h1>
            <div class="card" id="hotkeys-container"></div>
        </div>

        <!-- Dicts -->
        <div id="tab-dicts" class="tab-content">
            <h1>词库管理</h1>
            <div id="profiles-container"></div>
        </div>
    </main>

    <div id="toast" class="status-toast">已保存并应用</div>

    <script>
        let config = null;

        async function load() {
            const r = await fetch('/api/config');
            config = await r.json();
            
            // General
            document.getElementById('autostart').checked = config.input.autostart;
            document.getElementById('enable_fuzzy_pinyin').checked = config.input.enable_fuzzy_pinyin;
            document.getElementById('paste_method').value = config.input.paste_method;
            
            const ps = document.getElementById('default_profile');
            ps.innerHTML = config.files.profiles.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
            ps.value = config.input.default_profile;

            // Dictionary List for Learning Mode
            const dr = await fetch('/api/dicts');
            const dicts = await dr.json();
            const ls = document.getElementById('learning_dict_path');
            ls.innerHTML = dicts.map(d => `<option value="${d.path}">${d.name}</option>`).join('');
            ls.value = config.appearance.learning_dict_path;

            // Hotkeys
            const hc = document.getElementById('hotkeys-container');
            hc.innerHTML = '';
            for (const [key, val] of Object.entries(config.hotkeys)) {
                hc.innerHTML += `
                    <div class="setting-item">
                        <div class="info"><div class="title">${val.description}</div></div>
                        <input type="text" class="hotkey-input" data-id="${key}" value="${val.key}">
                    </div>
                `;
            }

            // Profiles
            const pc = document.getElementById('profiles-container');
            pc.innerHTML = config.files.profiles.map((p, i) => `
                <div class="card">
                    <div style="font-weight:700; font-size:18px; margin-bottom:10px;">${p.name}</div>
                    <div style="color:var(--apple-secondary); font-size:14px; margin-bottom:15px;">${p.description}</div>
                    <div style="font-size:12px; background:rgba(0,0,0,0.03); padding:10px; border-radius:8px;">
                        ${p.dicts.map(d => `<div style="margin-bottom:4px;">• ${d}</div>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById('nav-' + tab).classList.add('active');
        }

        async function saveAll() {
            // Collect all
            config.input.autostart = document.getElementById('autostart').checked;
            config.input.enable_fuzzy_pinyin = document.getElementById('enable_fuzzy_pinyin').checked;
            config.input.paste_method = document.getElementById('paste_method').value;
            config.input.default_profile = document.getElementById('default_profile').value;

            config.appearance.show_candidates = document.getElementById('show_candidates').checked;
            config.appearance.show_keystrokes = document.getElementById('show_keystrokes').checked;
            config.appearance.show_notifications = document.getElementById('show_notifications').checked;
            config.appearance.learning_mode = document.getElementById('learning_mode').checked;
            config.appearance.learning_interval_sec = parseInt(document.getElementById('learning_interval_sec').value);
            config.appearance.learning_dict_path = document.getElementById('learning_dict_path').value;

            config.appearance.candidate_anchor = document.getElementById('candidate_anchor').value;
            config.appearance.candidate_font_size = parseInt(document.getElementById('candidate_font_size').value);
            config.appearance.candidate_margin_x = parseInt(document.getElementById('candidate_margin_x').value);
            config.appearance.candidate_margin_y = parseInt(document.getElementById('candidate_margin_y').value);
            config.appearance.candidate_bg_color = document.getElementById('candidate_bg_color').value;

            config.appearance.keystroke_anchor = document.getElementById('keystroke_anchor').value;
            config.appearance.keystroke_font_size = parseInt(document.getElementById('keystroke_font_size').value);
            config.appearance.keystroke_timeout_ms = parseInt(document.getElementById('keystroke_timeout_ms').value);
            config.appearance.keystroke_bg_color = document.getElementById('keystroke_bg_color').value;

            document.querySelectorAll('.hotkey-input').forEach(el => {
                config.hotkeys[el.dataset.id].key = el.value;
            });

            const r = await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });

            if (r.ok) {
                const toast = document.getElementById('toast');
                toast.style.display = 'block';
                setTimeout(() => toast.style.display = 'none', 3000);
            }
        }

        async function compileDicts() {
            const toast = document.getElementById('toast');
            toast.textContent = '正在编译词库...';
            toast.style.display = 'block';
            try {
                const r = await fetch('/api/dicts/compile', { method: 'POST' });
                if (r.ok) {
                    toast.textContent = '词库编译成功';
                    setTimeout(() => toast.style.display = 'none', 3000);
                } else {
                    toast.textContent = '编译失败';
                }
            } catch (e) {
                toast.textContent = '编译异常: ' + e;
            }
        }

        async function resetAll() {
            if (!confirm("确定要重置所有配置为默认值吗？这将覆盖当前所有外观和快捷键设置。")) return;
            const r = await fetch('/api/config/reset', { method: 'POST' });
            if (r.ok) {
                const toast = document.getElementById('toast');
                toast.textContent = '配置已重置';
                toast.style.display = 'block';
                await load(); // 刷新界面数据
                setTimeout(() => {
                    toast.style.display = 'none';
                    toast.textContent = '已保存并应用';
                }, 3000);
            }
        }

        load();
    </script>
</body>
</html>