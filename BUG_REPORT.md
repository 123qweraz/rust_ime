# Bug Report - Rust IME (Blind IME)

**æŠ¥å‘Šæ—¥æœŸ**: 2026-01-28  
**é¡¹ç›®ç‰ˆæœ¬**: v0.1.0  
**æ£€æŸ¥å·¥å…·**: cargo clippy, cargo test, ä»£ç å®¡æŸ¥

---

## ğŸš¨ ä¸¥é‡é—®é¢˜ (Critical)

### 1. ç¼ºå¤±å­—å…¸æ–‡ä»¶
**ä¸¥é‡çº§åˆ«**: Critical  
**å½±å“èŒƒå›´**: æ ¸å¿ƒåŠŸèƒ½  

**é—®é¢˜æè¿°**:
- é…ç½®æ–‡ä»¶ `config.json` å¼•ç”¨äº†ä¸å­˜åœ¨çš„å­—å…¸æ–‡ä»¶
- `dicts/words.json` - å®Œå…¨ç¼ºå¤±
- `dicts/japanese/` ç›®å½• - å®Œå…¨ç¼ºå¤±

**å¤ç°æ­¥éª¤**:
1. å¯åŠ¨è¾“å…¥æ³•ç¨‹åº
2. å°è¯•ä½¿ç”¨ä¸­æ–‡è¾“å…¥
3. æ—¥å¿—æ˜¾ç¤ºå­—å…¸æ–‡ä»¶åŠ è½½é”™è¯¯

**é¢„æœŸç»“æœ**: æ­£å¸¸åŠ è½½å­—å…¸ï¼Œè¾“å…¥æ³•å·¥ä½œ
**å®é™…ç»“æœ**: å­—å…¸åŠ è½½å¤±è´¥ï¼Œéƒ¨åˆ†åŠŸèƒ½ä¸å¯ç”¨

**ä¿®å¤å»ºè®®**:
```bash
# åˆ›å»ºå ä½æ–‡ä»¶
touch dicts/words.json
mkdir -p dicts/japanese
# æˆ–è€…æ›´æ–°config.jsonç§»é™¤ä¸å­˜åœ¨çš„å¼•ç”¨
```

---

## âš ï¸ é«˜ä¼˜å…ˆçº§é—®é¢˜ (High)

### 2. å¤§é‡unwrap()è°ƒç”¨å­˜åœ¨panicé£é™©
**ä¸¥é‡çº§åˆ«**: High  
**å½±å“èŒƒå›´**: ç¨‹åºç¨³å®šæ€§  

**é—®é¢˜æè¿°**:
å‘ç°20å¤„`unwrap()`å’Œ`expect()`è°ƒç”¨ï¼Œé‡åˆ°é”™è¯¯æ—¶ç¨‹åºä¼španicè€Œéä¼˜é›…å¤„ç†

**å…³é”®ä½ç½®**:
- `src/main.rs:221` - `find_keyboard().unwrap()` è®¾å¤‡è·¯å¾„è·å–å¤±è´¥
- `src/main.rs:271` - é…ç½®é”è·å–å¤±è´¥
- `src/ime.rs:683` - `chars().next().unwrap()` å­—ç¬¦ä¸²ç´¢å¼•è¶Šç•Œ
- `src/ime.rs:1034` - `chars().nth(idx).unwrap()` æ•°ç»„è¶Šç•Œ
- `src/web.rs` å¤šå¤„ - é…ç½®é”è·å–å¤±è´¥

**å¤ç°æ­¥éª¤**:
1. æ¨¡æ‹Ÿé”®ç›˜è®¾å¤‡ä¸å­˜åœ¨
2. æ¨¡æ‹Ÿé…ç½®æ–‡ä»¶æŸå
3. è¾“å…¥ç‰¹æ®Šå­—ç¬¦è§¦å‘ç´¢å¼•è¶Šç•Œ

**ä¿®å¤å»ºè®®**:
```rust
// æ›¿ä»£æ–¹æ¡ˆç¤ºä¾‹
let device_path = match find_keyboard() {
    Ok(path) => path,
    Err(e) => {
        eprintln!("Warning: Cannot find keyboard device: {}", e);
        "/dev/input/event0".to_string() // é»˜è®¤å€¼
    }
};
```

### 3. å‡½æ•°å‚æ•°è¿‡å¤š
**ä¸¥é‡çº§åˆ«**: High  
**å½±å“èŒƒå›´**: ä»£ç ç»´æŠ¤æ€§  

**é—®é¢˜æè¿°**:
`Ime::new()`å‡½æ•°æœ‰12ä¸ªå‚æ•°ï¼Œè¶…è¿‡å»ºè®®çš„7ä¸ªå‚æ•°é™åˆ¶

**ä½ç½®**: `src/ime.rs:69-82`

**ä¿®å¤å»ºè®®**:
```rust
// ä½¿ç”¨æ„å»ºå™¨æ¨¡å¼
#[derive(Debug)]
struct ImeConfig {
    tries: HashMap<String, Trie>,
    initial_profile: String,
    punctuation: HashMap<String, String>,
    word_en_map: HashMap<String, Vec<String>>,
    notification_tx: Sender<NotifyEvent>,
    gui_tx: Option<Sender<crate::gui::GuiEvent>>,
    enable_fuzzy: bool,
    phantom_mode_str: String,
    enable_notifications: bool,
    base_ngram: NgramModel,
    user_ngram: NgramModel,
    user_ngram_path: std::path::PathBuf,
}

impl Ime {
    pub fn new(config: ImeConfig) -> Self { ... }
}
```

---

## ğŸ“‹ ä¸­ä¼˜å…ˆçº§é—®é¢˜ (Medium)

### 4. Clippyä»£ç è´¨é‡è­¦å‘Š (18ä¸ª)
**ä¸¥é‡çº§åˆ«**: Medium  
**å½±å“èŒƒå›´**: ä»£ç è´¨é‡

**è¯¦ç»†è­¦å‘Šåˆ—è¡¨**:

#### æ‰‹åŠ¨å®ç°æ ‡å‡†åº“å‡½æ•°
```rust
// å½“å‰ä»£ç 
if COMMIT_COUNT % 10 == 0 { ... }

// å»ºè®®
if COMMIT_COUNT.is_multiple_of(10) { ... }
```

#### ä¸å¿…è¦çš„èŒƒå›´æ£€æŸ¥
```rust
// å½“å‰ä»£ç   
if digit >= 1 && digit <= 5 { ... }

// å»ºè®®
if (1..=5).contains(&digit) { ... }
```

#### å­—ç¬¦ä¸²å¤„ç†
```rust
// å½“å‰ä»£ç 
if word.starts_with('/') {
    final_result.push_str(&word[1..]);
}

// å»ºè®®
if let Some(stripped) = word.strip_prefix('/') {
    final_result.push_str(stripped);
}
```

### 5. æ½œåœ¨æ— é™å¾ªç¯
**ä¸¥é‡çº§åˆ«**: Medium  
**ä½ç½®**: `src/ngram.rs:42`

**é—®é¢˜æè¿°**:
```rust
self.token_list = reader.lines().filter_map(|l| l.ok()).collect();
```

**é£é™©**: è¯»å–é”™è¯¯æ—¶`filter_map(|l| l.ok())`ä¼šæ— é™å¾ªç¯

**ä¿®å¤å»ºè®®**:
```rust
self.token_list = reader.lines().map_while(Result::ok).collect();
```

---

## ğŸ”§ ä½ä¼˜å…ˆçº§æ”¹è¿› (Low)

### 6. ä»£ç ç»„ç»‡é—®é¢˜
- æµ‹è¯•æ¨¡å—åä»æœ‰å‡½æ•°å®šä¹‰ (`src/ime.rs:1188`)
- ä¸å¿…è¦çš„returnè¯­å¥ (å¤šå¤„)
- å¯ç®€åŒ–çš„map_orè°ƒç”¨

### 7. æ€§èƒ½ä¼˜åŒ–æœºä¼š
- ä½¿ç”¨`is_some_and()`æ›¿ä»£`map_or(false, ...)`
- ç®€åŒ–åµŒå¥—ifè¯­å¥
- ä½¿ç”¨è¿­ä»£å™¨æ›¿ä»£æ‰‹åŠ¨ç´¢å¼•

---

## âœ… å¥åº·çŠ¶å†µæ£€æŸ¥

| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ | è¯¦æƒ… |
|---------|------|------|
| ç¼–è¯‘çŠ¶æ€ | âœ… æ­£å¸¸ | æ— ç¼–è¯‘é”™è¯¯ |
| å•å…ƒæµ‹è¯• | âœ… é€šè¿‡ | 7ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ |
| ä¾èµ–ç®¡ç† | âœ… æ­£å¸¸ | æ— é—®é¢˜ä¾èµ– |
| ä»£ç æ ¼å¼ | âš ï¸ è­¦å‘Š | 18ä¸ªclippyè­¦å‘Š |
| é”™è¯¯å¤„ç† | âš ï¸ é£é™© | 20å¤„panicé£é™©ç‚¹ |
| æ–‡ä»¶å®Œæ•´æ€§ | âŒ é—®é¢˜ | ç¼ºå¤±å…³é”®å­—å…¸æ–‡ä»¶ |

---

## ğŸ”¨ ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

### ç«‹å³ä¿®å¤ (P0)
1. åˆ›å»ºç¼ºå¤±çš„å­—å…¸æ–‡ä»¶
2. ä¿®å¤å…³é”®çš„panicé£é™©ç‚¹

### çŸ­æœŸä¿®å¤ (P1)
3. é‡æ„Ime::new()å‡½æ•°
4. ä¿®å¤ngram.rsæ— é™å¾ªç¯é—®é¢˜
5. è¿è¡Œ`cargo clippy --fix`è‡ªåŠ¨ä¿®å¤éƒ¨åˆ†è­¦å‘Š

### é•¿æœŸæ”¹è¿› (P2)
6. å®Œå–„é”™è¯¯å¤„ç†æœºåˆ¶
7. æ·»åŠ æ›´å¤šå•å…ƒæµ‹è¯•
8. ä¼˜åŒ–ä»£ç ç»“æ„å’Œæ€§èƒ½

---

## ğŸ“ æµ‹è¯•å»ºè®®

### å›å½’æµ‹è¯•ç”¨ä¾‹
```bash
# 1. æµ‹è¯•å­—å…¸æ–‡ä»¶ç¼ºå¤±æƒ…å†µ
cargo test -- --ignored dict_missing

# 2. æµ‹è¯•è®¾å¤‡ä¸å­˜åœ¨æƒ…å†µ  
cargo test -- --ignored device_not_found

# 3. æµ‹è¯•è¾¹ç•Œè¾“å…¥
cargo test -- --ignored edge_cases
```

### å‹åŠ›æµ‹è¯•
```bash
# é•¿æ—¶é—´è¿è¡Œæµ‹è¯•
cargo test --release -- --test-threads=1
```

---

**æ€»ç»“**: é¡¹ç›®åŠŸèƒ½å®Œæ•´ä½†å­˜åœ¨ç¨³å®šæ€§é£é™©ï¼Œå»ºè®®ä¼˜å…ˆè§£å†³å­—å…¸æ–‡ä»¶ç¼ºå¤±å’Œé”™è¯¯å¤„ç†é—®é¢˜ï¼Œä»¥æé«˜ç”Ÿäº§ç¯å¢ƒå¯ç”¨æ€§ã€‚