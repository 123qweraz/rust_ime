# Rust-IME 已知 Bug 与安全风险报告

本文件记录了在静态代码分析中发现的问题，按严重程度排序。

---

## 1. 严重安全漏洞 (Security)

### 1.1 Web 控制台全局监听 [FIXED]
- **位置**: `src/web.rs`
- **状态**: 已修复 (已将监听地址限制为 127.0.0.1)
- **描述**: `WebServer` 默认监听 `0.0.0.0`，允许局域网内的任何设备访问 `8765` 端口。
- **影响**: 攻击者可以远程读取/修改你的 `config.json`，或通过词典编辑器 API 篡改本地词典文件。
- **建议修复**: 默认改为监听 `127.0.0.1`。

### 1.2 路径验证失效
- **位置**: `src/main.rs` -> `validate_path`
- **描述**: 路径安全检查代码被注释掉，仅输出警告但仍执行操作。
- **影响**: 如果 Web 端 API 调用此函数，可能存在任意文件读取风险。
- **建议修复**: 恢复 `starts_with(&project_root)` 的硬性检查。

---

## 2. 核心逻辑 Bug (Logic)

### 2.1 声调过滤损坏拼音结构
- **位置**: `src/ime.rs` -> `handle_composing` (Key 7, 8, 9, 0)
- **描述**: 程序通过 `self.buffer.pop()` 移除最后一个字母并替换为带调元音。
- **示例**: 输入 `zhong` 后按 `9` (三声)，结果会变成 `zhonǎ`（`g` 被弹出了），而不是正确的 `zhǒng`。
- **建议修复**: 识别拼音中的主元音进行替换，或仅在元音结尾时允许替换。

### 2.2 预览模式 (PhantomMode) 退格残留
- **位置**: `src/ime.rs` -> `Key::KEY_BACKSPACE`
- **描述**: 在预览高亮状态下，退格仅删除 1 个字符 (`delete_count = 1`)。
- **影响**: 在部分窗口管理器或终端中，由于选中替换机制不同，可能导致预览用的 `[]` 符号残留在屏幕上。
- **建议修复**: 根据实际发出的字符数动态计算需要删除的长度。

---

## 3. 运行环境与稳定性 (Stability)

### 3.1 Root 权限运行冲突
- **位置**: `src/main.rs` -> `detect_environment`
- **描述**: 虽然有警告，但程序仍允许 root 运行。
- **影响**: Root 运行会导致 `arboard` (剪贴板) 无法连接到普通用户的图形会话，造成中文无法上屏。
- **建议修复**: 检测到 root 运行时强制退出并提示正确的加组方式。

### 3.2 词典加载死锁风险
- **位置**: `src/web.rs` -> `reload_dicts`
- **描述**: 在持有 `config` 读锁的情况下进行耗时的磁盘 IO。
- **影响**: 并发访问量大时可能导致 `tries` 写锁饥饿，造成 Web 界面卡死。
- **建议修复**: 先读取配置，释放锁后再加载文件，最后一次性更新。

---
*报告生成日期：2026-01-27*
